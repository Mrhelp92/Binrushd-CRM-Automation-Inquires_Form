<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù…ÙŠÙ„ - Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù† Ø±Ø´Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ©</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#E4252A;
      --brand-dark:#B92024;
      --brand-soft:#F08D90;
      --bg:#0b0b0e;
      --muted:#a9a9b6;
      --text:#f4f4f7;
      --stroke: rgba(255,255,255,0.12);
      --shadow: 0 18px 40px rgba(0,0,0,0.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Arial;
      background:
        radial-gradient(900px 600px at 85% 10%, rgba(228,37,42,0.28), transparent 55%),
        radial-gradient(700px 500px at 15% 40%, rgba(240,141,144,0.14), transparent 60%),
        linear-gradient(180deg, #07070a, #0b0b0e);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .wrap{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap:18px;
    }

    @media (max-width: 900px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .header{
      padding:20px 22px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      gap:14px;
    }

    .logoMark{
      width:44px;
      height:44px;
      border-radius:12px;
      background: linear-gradient(180deg, var(--brand-soft), var(--brand));
      display:grid;
      place-items:center;
      box-shadow: 0 10px 24px rgba(228,37,42,0.25);
      flex:0 0 auto;
    }

    .logoMark span{
      font-weight:900;
      font-size:22px;
      color:white;
    }

    .title h1{
      font-size:18px;
      margin:0;
      font-weight:800;
    }

    .title p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:13px;
    }

    .content{ padding:18px 22px 22px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }

    @media (max-width: 700px){
      .grid{ grid-template-columns:1fr; }
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }

    .field{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color:var(--text);
      outline:none;
      font-size:14px;
    }

    .field[disabled]{
      opacity:0.85;
      cursor:not-allowed;
      background: rgba(255,255,255,0.05);
    }

    textarea.field{
      min-height:120px;
      resize:vertical;
    }

    .actions{
      margin-top:14px;
      display:flex;
      gap:10px;
      justify-content:space-between;
    }

    .btn{
      border:0;
      padding:12px 16px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      font-family:inherit;
    }

    .btn-primary{
      background: linear-gradient(180deg, var(--brand), var(--brand-dark));
      color:white;
    }

    .btn-ghost{
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border:1px solid var(--stroke);
    }

    .meta{
      padding:18px 22px;
      color:var(--muted);
      font-size:13px;
    }

    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      border:1px solid var(--stroke);
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,0.05);
      margin-top:10px;
      font-size:12px;
    }

    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.25);
      display:none;
      font-size:13px;
    }

    .toast.show{ display:block; }
    .toast.ok{ border-color:#2ecc71; }
    .toast.err{ border-color:#e74c3c; }
  </style>
</head>

<body>

<div class="wrap">

  <div class="card">
    <div class="header">
      <div class="logoMark"><span>B</span></div>
      <div class="title">
        <h1>Ù†Ù…ÙˆØ°Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù…ÙŠÙ„</h1>
        <p>Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù† Ø±Ø´Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ©</p>
      </div>
    </div>

    <div class="content">
      <form id="followupForm">

        <div class="grid">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input id="leadName" class="field" disabled />
          </div>

          <div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
            <input id="leadPhone" class="field" disabled />
          </div>

          <div>
            <label>Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ Ù„Ù„ØªÙˆØ§ØµÙ„</label>
            <input id="dueDate" class="field" disabled />
          </div>

          <div>
            <label>ØªØ§Ø±ÙŠØ® / ÙˆÙ‚Øª Ø§Ù„ØªÙˆØ§ØµÙ„</label>
            <input id="contactedAt" type="datetime-local" class="field" required />
          </div>
        </div>

        <div style="margin-top:14px">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ±Ø¹</label>
          <textarea id="notes" class="field" required></textarea>
        </div>

        <div class="actions">
          <button class="btn btn-primary" type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«</button>
          <button class="btn btn-ghost" type="button" id="refreshBtn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div id="toast" class="toast"></div>

        <input type="hidden" id="leadId">
        <input type="hidden" id="branchId">
        <input type="hidden" id="sig">
      </form>
    </div>
  </div>

  <div class="card">
    <div class="meta">
      <div class="pill">Lead ID: <span id="leadIdPreview">â€”</span></div><br>
      <div class="pill">Branch ID: <span id="branchIdPreview">â€”</span></div>
    </div>
  </div>

</div>

<script>
  const API_BASE = "https://YOUR-FASTAPI-DOMAIN.com"; // ğŸ‘ˆ Ø¹Ø¯Ù„Ù‡Ø§

  const qs = k => new URLSearchParams(location.search).get(k) || "";

  const toast = (msg, type) => {
    const t = document.getElementById("toast");
    t.className = "toast show " + (type || "");
    t.textContent = msg;
  };

  async function init(){
    const lead_id = qs("lead_id");
    const branch_id = qs("branch_id");
    const sig = qs("sig");

    if(!lead_id || !branch_id || !sig){
      toast("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ÙƒØªÙ…Ù„", "err");
      return;
    }

    leadId.value = lead_id;
    branchId.value = branch_id;
    sigInput.value = sig;

    leadIdPreview.textContent = lead_id;
    branchIdPreview.textContent = branch_id;

    try{
      const res = await fetch(
        `${API_BASE}/form/open?lead_id=${lead_id}&branch_id=${branch_id}&sig=${sig}&ua=${encodeURIComponent(navigator.userAgent)}`
      );
      const j = await res.json();

      if(!j.ok) return toast(j.error || "Ø®Ø·Ø£", "err");

      leadName.value  = j.data.lead_name || "";
      leadPhone.value = j.data.lead_phone || "";
      dueDate.value   = j.data.due_date || "";

      toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "ok");
    }catch{
      toast("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©", "err");
    }
  }

  refreshBtn.onclick = init;

  followupForm.onsubmit = async e => {
    e.preventDefault();

    try{
      const res = await fetch(`${API_BASE}/form/submit`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          lead_id: leadId.value,
          branch_id: branchId.value,
          sig: sigInput.value,
          contacted_at: contactedAt.value,
          notes: notes.value
        })
      });

      const j = await res.json();
      if(!j.ok) return toast(j.error || "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", "err");

      notes.value = "";
      toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­", "ok");
    }catch{
      toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„", "err");
    }
  };

  const leadId = document.getElementById("leadId");
  const branchId = document.getElementById("branchId");
  const sigInput = document.getElementById("sig");
  const leadIdPreview = document.getElementById("leadIdPreview");
  const branchIdPreview = document.getElementById("branchIdPreview");
  const leadName = document.getElementById("leadName");
  const leadPhone = document.getElementById("leadPhone");
  const dueDate = document.getElementById("dueDate");
  const contactedAt = document.getElementById("contactedAt");
  const notes = document.getElementById("notes");
  const refreshBtn = document.getElementById("refreshBtn");
  const followupForm = document.getElementById("followupForm");

  init();
</script>

</body>
</html>
